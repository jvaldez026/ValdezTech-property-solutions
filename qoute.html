/***********************************************************
 * pricing.js
 * ---------------------------------------------------------
 * Handles all pricing logic and estimate calculations.
 * Does NOT handle maps, addresses, or GIS lookups directly.
 ***********************************************************/

// Global application state (shared across files)
window.appState = window.appState || {
  location: {
    lat: null,
    lon: null,
    parcelSqFt: null,
    buildingSqFt: null
  },
  service: null,
  estimate: null
};

/**
 * Pricing rules by service type
 */
const PRICING_RULES = {
  exterior: {
    label: "Exterior Surface Cleaning",
    source: "parcel",
    rate: 0.12,
    minimum: 129
  },
  driveway: {
    label: "Driveway Cleaning",
    source: "parcel",
    rate: 0.18,
    minimum: 99
  },
  siding: {
    label: "House Siding Wash",
    source: "building",
    rate: 0.20,
    minimum: 149
  },
  sidewalk: {
    label: "Sidewalk Cleaning",
    source: "parcel",
    rate: 0.04,
    minimum: 79
  }
};

/**
 * Fallback sizes (used until GIS resolves)
 */
const FALLBACK_SIZES = {
  parcelSqFt: 6500,
  buildingSqFt: 1800
};

/**
 * Redirect to scheduling with estimate + GIS metadata
 */
function goToScheduling() {
  const state = window.appState;

  if (!state.estimate || !state.service) return;

  const addressEl = document.getElementById("address");
  const address = addressEl ? addressEl.value : "";

  const params = new URLSearchParams({
    service: state.service,
    estimate: state.estimate,
    address,
    lat: state.location.lat ?? "",
    lon: state.location.lon ?? "",
    parcelSqFt: state.location.parcelSqFt ?? "",
    buildingSqFt: state.location.buildingSqFt ?? "",
    timestamp: new Date().toISOString()
  });

  window.location.href = `schedule.html?${params.toString()}`;
}

/**
 * Main estimate calculation
 */
function calculateEstimate(serviceKey) {
  const rule = PRICING_RULES[serviceKey];
  if (!rule) return null;

  let area =
    rule.source === "building"
      ? window.appState.location.buildingSqFt ?? FALLBACK_SIZES.buildingSqFt
      : window.appState.location.parcelSqFt ?? FALLBACK_SIZES.parcelSqFt;

  if (!area || area <= 0) return null;

  let total = area * rule.rate;
  if (total < rule.minimum) total = rule.minimum;

  return Math.round(total);
}

/**
 * Update estimate display + CTA state
 */
function updateEstimateUI() {
  const priceEl = document.getElementById("estimatePrice");
  const buttonEl = document.getElementById("continueBtn");

  if (!priceEl || !buttonEl) return;

  const service = window.appState.service;
  if (!service) {
    priceEl.textContent = "$—";
    buttonEl.disabled = true;
    return;
  }

  const estimate = calculateEstimate(service);
  if (!estimate) {
    priceEl.textContent = "$—";
    buttonEl.disabled = true;
    return;
  }

  window.appState.estimate = estimate;
  priceEl.textContent = `$${estimate.toLocaleString()}.00`;
  buttonEl.disabled = false;
}

/**
 * UI Event listeners
 */
document.addEventListener("DOMContentLoaded", () => {
  const serviceSelect = document.getElementById("serviceType");
  const continueBtn = document.getElementById("continueBtn");

  if (serviceSelect) {
    serviceSelect.addEventListener("change", (e) => {
      window.appState.service = e.target.value;
      updateEstimateUI();
    });
  }

  if (continueBtn) {
    continueBtn.addEventListener("click", goToScheduling);
  }
});
